<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>Daily Sales Report</title>
<link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
<style>
  :root {
    --primary: #8c6d1f;
    --secondary: #d4af37;
    --accent: #c19a1b;
    --light: #ffffff;
    --dark: #5d4d0f;
    --border: #e0d6b3;
    --shadow: 0 4px 6px rgba(140, 109, 31, 0.1);
    --radius: 8px;
    --transition: all 0.3s ease;
  }
  * { box-sizing: border-box; margin: 0; padding: 0; }
  body {
    font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
    background: linear-gradient(135deg, #ffffff 0%, #fefefe 100%);
    color: var(--dark);
    line-height: 1.6;
    padding: 20px;
    min-height: 100vh;
  }
  .container { max-width: 1200px; margin: 0 auto; }
  .header { 
    text-align: center; 
    margin-bottom: 30px; 
    padding: 20px; 
    background: white; 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
    border: 1px solid var(--border);
  }
  .header h1 { 
    color: var(--primary); 
    font-weight: 700; 
    margin-bottom: 8px; 
    font-size: 32px; 
  }
  .header p { 
    color: #8a7c4a; 
    font-size: 16px; 
  }
  .controls { 
    display: flex; 
    justify-content: center; 
    align-items: center; 
    gap: 15px; 
    margin-bottom: 20px; 
    padding: 20px; 
    background: white; 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
    flex-wrap: wrap; 
    border: 1px solid var(--border);
  }
  .date-control { 
    display: flex; 
    align-items: center; 
    gap: 10px; 
  }
  .date-control label { 
    font-weight: 600; 
    color: var(--dark); 
  }
  .date-control input, .date-control select {
    padding: 10px 15px; 
    border: 1px solid var(--border); 
    border-radius: var(--radius); 
    font-size: 16px; 
    transition: var(--transition);
    background-color: #fefcf5;
  }
  .date-control input:focus, .date-control select:focus { 
    outline: none; 
    border-color: var(--secondary); 
    box-shadow: 0 0 0 3px rgba(212, 175, 55, 0.2); 
  }
  .btn { 
    padding: 12px 24px; 
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white; 
    border: none; 
    border-radius: var(--radius); 
    font-size: 16px; 
    font-weight: 600; 
    cursor: pointer; 
    transition: var(--transition); 
    display: flex; 
    align-items: center; 
    gap: 8px; 
    border: 1px solid var(--secondary);
  }
  .btn:hover { 
    background: linear-gradient(135deg, var(--secondary) 0%, var(--primary) 100%);
    transform: translateY(-2px); 
    box-shadow: 0 4px 8px rgba(140, 109, 31, 0.15); 
  }
  .btn-print { 
    background: linear-gradient(135deg, #27ae60 0%, #2ecc71 100%);
  }
  .btn-print:hover { 
    background: linear-gradient(135deg, #219653 0%, #27ae60 100%);
  }
  .report-container { 
    background: white; 
    border-radius: var(--radius); 
    box-shadow: var(--shadow); 
    overflow: hidden; 
    margin-bottom: 30px; 
    display: none; 
    border: 1px solid var(--border);
  }
  .report-header { 
    background: linear-gradient(135deg, var(--primary) 0%, var(--secondary) 100%);
    color: white; 
    padding: 25px; 
    text-align: center; 
  }
  .report-header h2 { 
    margin-bottom: 10px; 
    font-weight: 700; 
    font-size: 28px; 
  }
  .report-header p { 
    font-size: 16px; 
    opacity: 0.9; 
  }
  .report-body { 
    padding: 30px; 
  }
  .report-section { 
    margin-bottom: 30px; 
  }
  .report-section h3 { 
    color: var(--primary); 
    margin-bottom: 20px; 
    padding-bottom: 10px; 
    border-bottom: 2px solid var(--border); 
    display: flex; 
    align-items: center; 
    gap: 10px; 
    font-size: 22px; 
  }
  .report-section h3 i { 
    font-size: 24px; 
    color: var(--secondary); 
  }
  table { 
    width: 100%; 
    border-collapse: collapse; 
    margin-top: 15px; 
    font-size: 14px; 
    box-shadow: 0 2px 4px rgba(140, 109, 31, 0.05); 
  }
  th, td { 
    padding: 14px 16px; 
    text-align: left; 
    border-bottom: 1px solid var(--border); 
  }
  th { 
    background: #fef8e7; 
    font-weight: 600; 
    color: var(--dark); 
    position: sticky; 
    top: 0; 
  }
  tr:hover { 
    background: #fef8e7; 
  }
  .summary { 
    margin-top: 30px; 
    padding: 20px; 
    background: #fef8e7; 
    border-radius: var(--radius); 
    border-left: 4px solid var(--secondary); 
  }
  .summary h3 { 
    color: var(--primary); 
    margin-bottom: 15px; 
    font-size: 20px; 
  }
  .summary div { 
    margin-bottom: 10px; 
    font-weight: 600; 
    font-size: 16px; 
    padding: 8px 0; 
    border-bottom: 1px dashed var(--border); 
  }
  .summary div:last-child { 
    border-bottom: none; 
  }
  .voided { 
    color: #e74c3c; 
    font-weight: bold; 
  }
  .status-active { 
    color: #27ae60; 
    font-weight: 600; 
  }
  .loading { 
    text-align: center; 
    padding: 40px; 
    color: #8a7c4a; 
  }
  .loading i { 
    font-size: 36px; 
    margin-bottom: 15px; 
    color: var(--secondary); 
  }
  .empty-state { 
    text-align: center; 
    padding: 50px; 
    color: #8a7c4a; 
  }
  .empty-state i { 
    font-size: 48px; 
    margin-bottom: 15px; 
    color: #e0d6b3; 
  }
  .empty-state p { 
    font-size: 18px; 
  }
  @media (max-width: 768px) {
    .controls { flex-direction: column; }
    .date-control { flex-direction: column; width: 100%; }
    .report-body { padding: 20px; }
    table { font-size: 12px; }
    th, td { padding: 10px 12px; }
    .header h1 { font-size: 24px; }
    .report-header h2 { font-size: 22px; }
  }
  @media print {
    body { background: white; padding: 0; }
    .container { max-width: 100%; }
    .header, .controls { display: none; }
    .report-container { display: block !important; box-shadow: none; margin: 0; width: 100%; border: none; }
    .report-header { 
      background: white !important; 
      color: black; 
      border-bottom: 2px solid #000; 
    }
    .report-header h2 { color: black; }
    table { box-shadow: none; }
    th { 
      background: #f0f0f0 !important; 
      -webkit-print-color-adjust: exact; 
      color-adjust: exact; 
    }
    .summary {
      background: #f0f0f0 !important;
      border-left: 4px solid #000 !important;
    }
  }
</style>
</head>
<body>

<div class="container">
  <div class="header">
    <h1 id="companyName">Daily Sales Report</h1>
    <p>Generate and analyze daily sales performance</p>
  </div>

  <div class="controls">
    <div class="date-control">
      <label for="reportDate"><i class="fas fa-calendar-alt"></i> Select Date:</label>
      <input type="date" id="reportDate">
    </div>
    
    <div class="date-control">
      <label for="shiftSelect"><i class="fas fa-clock"></i> Select Shift:</label>
      <select id="shiftSelect">
        <option value="">All Shifts</option>
        <option value="Morning">Morning</option>
        <option value="Evening">Evening</option>
      </select>
    </div>

    <button id="generateBtn" class="btn"><i class="fas fa-chart-line"></i> Generate Report</button>
    <button onclick="printReport()" class="btn btn-print"><i class="fas fa-print"></i> Print Report</button>

          
        <a href="dashboard.html" class="btn-dashboard">
          <i class="fas fa-home"></i> Dashboard
        </a>
      </div>
  </div>

  <div class="report-container" id="reportContainer">
    <div class="report-header">
      <h2 id="reportTitle">Daily Sales Report</h2>
      <p id="reportDateText"></p>
    </div>

    <div class="report-body">
      <div class="report-section">
        <h3><i class="fas fa-receipt"></i> Active Receipts</h3>
        <table id="receiptsTable">
          <thead>
            <tr>
              <th>Receipt No</th>
              <th>Flight No</th>
              <th>Payment Type</th>
              <th>Currency</th>
              <th>Total Amount</th>
              <th>Batch No</th>
              <th>Approval Code</th>
              <th>Shift</th>
              <th>Status</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="report-section">
        <h3><i class="fas fa-times-circle"></i> Voided Receipts</h3>
        <table id="voidedTable">
          <thead>
            <tr>
              <th>Receipt No</th>
              <th>Payment Type</th>
              <th>Currency</th>
              <th>Total Amount</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>

      <div class="summary" id="summaryDiv"></div>
    </div>
  </div>
</div>

<script src="Co.js"></script>
<script>
document.getElementById("companyName").innerText = companyInfo.name || "Company Name";
</script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-firestore-compat.js"></script>
<script src="fire2.js"></script>

<script>
const reportDateInput = document.getElementById("reportDate");
const generateBtn = document.getElementById("generateBtn");
const shiftSelect = document.getElementById("shiftSelect");
const reportContainer = document.getElementById("reportContainer");
const reportTitle = document.getElementById("reportTitle");
const reportDateText = document.getElementById("reportDateText");
const summaryDiv = document.getElementById("summaryDiv");
const receiptsTableBody = document.querySelector("#receiptsTable tbody");
const voidedTableBody = document.querySelector("#voidedTable tbody");

// Set default date to today
const today = new Date();
reportDateInput.value = today.toISOString().split('T')[0];

generateBtn.addEventListener("click", async () => {
  const selectedDate = reportDateInput.value;
  const selectedShift = shiftSelect.value;

  if(!selectedDate) return alert("Select a valid date");

  reportContainer.style.display = "block";
  reportTitle.innerText = `Sales Report for ${selectedDate}`;
  reportDateText.innerText = `Generated on: ${new Date().toLocaleDateString()}`;

  try {
    receiptsTableBody.innerHTML = '<tr><td colspan="9" class="loading"><i class="fas fa-spinner fa-spin"></i> Loading data...</td></tr>';
    voidedTableBody.innerHTML = '';
    summaryDiv.innerHTML = '';

    const start = new Date(selectedDate + "T00:00:00");
    const end = new Date(selectedDate + "T23:59:59");

    const snapshot = await db.collection("payments")
      .where("timestamp", ">=", start)
      .where("timestamp", "<=", end)
      .get();

    let totalsCashByCurrency = {};
    let totalsNonCashByTypeCurrency = {};
    let voidedByTypeCurrency = {};

    receiptsTableBody.innerHTML = "";
    voidedTableBody.innerHTML = "";

    snapshot.docs.forEach(doc => {
      const data = doc.data();

      // Filter by shift
      if(selectedShift && data.shift != selectedShift) return;

      const key = `${data.paymentType} (${data.currency})`;

      if(data.voided){
        if(data.paymentType.toLowerCase() === "cash"){
          if(!voidedByTypeCurrency[data.currency]) voidedByTypeCurrency[data.currency] = 0;
          voidedByTypeCurrency[data.currency] += data.total;
        } else {
          if(!voidedByTypeCurrency[key]) voidedByTypeCurrency[key] = 0;
          voidedByTypeCurrency[key] += data.total;
        }

        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.receiptNo}</td>
          <td class="voided">-</td>
          <td class="voided">${data.paymentType}</td>
          <td class="voided">${data.currency}</td>
          <td class="voided">${data.total.toFixed(2)}</td>
        `;
        voidedTableBody.appendChild(tr);

      } else {
        const tr = document.createElement("tr");
        tr.innerHTML = `
          <td>${data.receiptNo}</td>
          <td>${data.flight || '-'}</td>
          <td>${data.paymentType}</td>
          <td>${data.currency}</td>
          <td>${data.total.toFixed(2)}</td>
          <td>${data.batchNo || '-'}</td>
          <td>${data.approvalCode || '-'}</td>
          <td>${data.shift || '-'}</td>
          <td class="status-active">Active</td>
        `;
        receiptsTableBody.appendChild(tr);

        if(data.paymentType.toLowerCase() === "cash"){
          if(!totalsCashByCurrency[data.currency]) totalsCashByCurrency[data.currency] = 0;
          totalsCashByCurrency[data.currency] += data.total;
        } else {
          if(!totalsNonCashByTypeCurrency[key]) totalsNonCashByTypeCurrency[key] = 0;
          totalsNonCashByTypeCurrency[key] += data.total;
        }
      }
    });

    for(const curr in totalsCashByCurrency){ if(voidedByTypeCurrency[curr]) totalsCashByCurrency[curr] -= voidedByTypeCurrency[curr]; }
    for(const key in totalsNonCashByTypeCurrency){ if(voidedByTypeCurrency[key]) totalsNonCashByTypeCurrency[key] -= voidedByTypeCurrency[key]; }

    summaryDiv.innerHTML = "<h3>Summary (Active Receipts Only, Voided Excluded)</h3>";
    for(const curr in totalsCashByCurrency){ if(totalsCashByCurrency[curr] > 0) summaryDiv.innerHTML += `<div>Total Cash in ${curr}: ${totalsCashByCurrency[curr].toFixed(2)}</div>`; }
    for(const key in totalsNonCashByTypeCurrency){ if(totalsNonCashByTypeCurrency[key] > 0) summaryDiv.innerHTML += `<div>Total by ${key}: ${totalsNonCashByTypeCurrency[key].toFixed(2)}</div>`; }

    if (receiptsTableBody.children.length === 0 && voidedTableBody.children.length === 0) {
      receiptsTableBody.innerHTML = '<tr><td colspan="9" class="empty-state"><i class="fas fa-receipt"></i><p>No receipts found for this date/shift</p></td></tr>';
    }

  } catch(err){
    console.error("Error generating report:", err);
    receiptsTableBody.innerHTML = '<tr><td colspan="9" style="color: #e74c3c; text-align: center; padding: 20px;">Error generating report: ' + err.message + '</td></tr>';
  }
});

function printReport(){ window.print(); }
</script>

</body>
</html>
